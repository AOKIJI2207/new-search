<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AGORAFLUX</title>
  <style>
    :root{--bg:#0b0f17;--card:#121a29;--text:#e7ecf5;--muted:#a9b4c7;--border:rgba(255,255,255,.10);--accent:#6aa6ff;--glow:rgba(106,166,255,.25);--map-image:url("assets/world-map.png")}
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
      color:var(--text);
      background:
        radial-gradient(900px 480px at 10% -10%, rgba(106,166,255,.25), transparent 60%),
        radial-gradient(700px 420px at 90% 0%, rgba(106,166,255,.18), transparent 60%),
        linear-gradient(180deg,#070a12,#0b0f17);
      background-attachment: fixed;
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background-image:var(--map-image);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      opacity: 0.6;
      filter: contrast(1.15) saturate(1.15);
      pointer-events: none;
      z-index: -1;
    }
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(10px);background:rgba(11,15,23,.75);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:18px}
    .sub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.35}
    main{display:grid;grid-template-columns:.55fr 1.6fr .9fr;gap:14px;padding:14px 16px 32px;max-width:1200px;margin:0 auto}
    @media(max-width:1080px){main{grid-template-columns:1fr}}
    .panel{background:rgba(18,26,41,.45);border:1px solid rgba(255,255,255,.14);border-radius:16px;overflow:hidden;box-shadow:0 20px 40px rgba(0,0,0,.25);backdrop-filter:blur(6px)}
    .hd{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--border);flex-wrap:wrap}
    .bd{padding:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,textarea,button{background:#0c1220;color:var(--text);border:1px solid var(--border);padding:10px 11px;border-radius:12px;font:inherit}
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg,rgba(106,166,255,.25),rgba(106,166,255,.12));border-color:rgba(106,166,255,.35);box-shadow:0 10px 20px rgba(106,166,255,.15)}
    .badge{font-size:12px;color:var(--muted);border:1px solid var(--border);padding:6px 10px;border-radius:999px}
    .articles{display:grid;gap:10px}
    article{background:rgba(12,18,32,.38);border:1px solid rgba(255,255,255,.14);border-radius:14px;padding:12px}
    article h3{margin:0 0 6px 0;font-size:15px;line-height:1.25}
    .idx{display:inline-flex;align-items:center;justify-content:center;min-width:22px;height:22px;border-radius:999px;background:rgba(106,166,255,.15);border:1px solid rgba(106,166,255,.35);color:#cfe1ff;font-size:12px;margin-right:8px}
    .meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;color:var(--muted);font-size:12px}
    .snippet{margin-top:8px;color:#d7def0;line-height:1.45;font-size:14px}
    a{color:#cfe1ff}
    .chat{display:flex;flex-direction:column;height:72vh;min-height:520px}
    .chatlog{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
    .msg{max-width:92%;padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(12,18,32,.38)}
    .msg.user{align-self:flex-end;border-color:rgba(106,166,255,.35)}
    .who{font-size:12px;color:var(--muted);margin-bottom:6px}
    .txt{white-space:pre-wrap;line-height:1.4;font-size:14px}
    .cites{margin-top:8px;font-size:12px;color:var(--muted)}
    .small{font-size:12px;color:var(--muted);line-height:1.35}
    .sources{display:flex;flex-wrap:wrap;gap:10px}
    .src{display:flex;gap:8px;align-items:center;font-size:13px;color:var(--muted)}
    .toggle{display:flex;gap:8px;align-items:center;font-size:13px;color:var(--muted);background:rgba(12,18,32,.6);border:1px solid var(--border);padding:6px 10px;border-radius:999px}
    .source-actions{display:flex;gap:8px;flex-wrap:wrap}
    .ghost{background:transparent;border:1px dashed var(--border);color:var(--muted)}
    .idx{display:inline-flex;align-items:center;justify-content:center;min-width:22px;height:22px;border-radius:999px;background:rgba(106,166,255,.15);border:1px solid rgba(106,166,255,.35);color:#cfe1ff;font-size:12px;margin-right:8px}
    .bg-input{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .bg-input input{min-width:240px;flex:1}
    .bg-input .note{flex-basis:100%}
    .continents{position:sticky;top:90px;align-self:start}
    .tablist{display:flex;flex-direction:column;gap:8px}
    .tablist button{width:100%;text-align:left;border-radius:12px;background:rgba(12,18,32,.38);border:1px solid rgba(255,255,255,.14);padding:10px 12px}
    .tablist button.active{border-color:rgba(106,166,255,.55);background:rgba(106,166,255,.15);color:#cfe1ff}
    .tablist .small{margin-top:6px}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1 id="siteName">AGORAFLUX</h1>
    <div class="sub">Tape un mot-clé (ex: “Groenland”, “cybersécurité”, “OTAN”). Résultats issus de flux RSS ouverts. Si aucune source n’est cochée, la recherche utilise toutes les sources.</div>
  </div>
</header>

<main>
  <aside class="panel continents">
    <div class="hd">
      <div class="row">
        <span class="badge">Continents</span>
        <span class="small">onglets</span>
      </div>
    </div>
    <div class="bd">
      <div class="tablist" id="continentTabs"></div>
      <div class="small" style="margin-top:10px">Chaque onglet recharge les sources liées à la zone sélectionnée.</div>
    </div>
  </aside>

  <section class="panel">
    <div class="hd">
      <div class="row">
        <span class="badge" id="status">Prêt</span>
        <span class="small" id="count"></span>
      </div>
      <div class="row">
        <input id="q" type="search" placeholder='Ex: Groenland | cybersécurité | OTAN arctique' style="min-width:280px"/>
        <button class="primary" id="searchBtn">Rechercher</button>
      </div>
    </div>

    <div class="bd">
      <div class="row source-actions">
        <button class="ghost" id="selectAll">Tout sélectionner</button>
        <button class="ghost" id="clearAll">Tout désélectionner</button>
        <label class="toggle">
          <input type="checkbox" id="toggleSources" checked />
          Afficher les sources
        </label>
      </div>
      <div style="height:10px"></div>
      <div class="row bg-input">
        <input id="bgUrl" type="url" placeholder="URL d’image de fond (ou data:image/...)" />
        <button class="ghost" id="applyBg">Appliquer</button>
        <button class="ghost" id="resetBg">Réinitialiser</button>
        <div class="small note">Astuce : utilise une URL publique ou un data URI base64 pour voir le fond s’afficher immédiatement.</div>
      </div>
      <div style="height:8px"></div>
      <div class="sources" id="sourceToggles"></div>
      <div style="height:10px"></div>
      <div class="articles" id="articles"></div>
    </div>
  </section>

  <aside class="panel chat">
    <div class="hd">
      <div class="row">
        <span class="badge">Chatbot</span>
        <span class="small">réponses sourcées</span>
      </div>
      <button class="primary" id="reset">Réinitialiser</button>
    </div>

    <div class="chatlog" id="chatlog"></div>

    <div class="bd" style="padding-top:0">
      <div class="row">
        <textarea id="prompt" placeholder="Ex : résume les infos majeures" style="flex:1; height:44px"></textarea>
        <button class="primary" id="send">Envoyer</button>
      </div>
      <div class="small" style="margin-top:10px">Astuce : demande “résume les articles”, “résume l’article #3”, “cite tes sources”.</div>
    </div>
  </aside>
</main>

<script>
  const $ = s => document.querySelector(s);
  const SITE_NAME = "AGORAFLUX";
  document.title = SITE_NAME;
  const siteNameEl = $("#siteName");
  if(siteNameEl) siteNameEl.textContent = SITE_NAME;
  const escapeHtml = s => (s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const norm = s => (s||"").toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"").replace(/[^a-z0-9\\s-]/g," ").replace(/\\s+/g," ").trim();
  const tokenize = s => norm(s).split(" ").filter(t=>t.length>=2);

  let SOURCES = [];
  let selected = new Set();
  let ITEMS = [];
  let activeContinent = "global";
  const CONTINENTS = [
    { key: "global", label: "Global" },
    { key: "Afrique", label: "Afrique" },
    { key: "Amérique du Nord", label: "Amérique du Nord" },
    { key: "Amérique du Sud", label: "Amérique du Sud" },
    { key: "Asie", label: "Asie" },
    { key: "Europe", label: "Europe" },
    { key: "Océanie", label: "Océanie" }
  ];
  const DEFAULT_BG = getComputedStyle(document.documentElement).getPropertyValue("--map-image").trim();
  const BG_STORAGE_KEY = "customMapImageV2";
  const isValidBg = url => /^data:image\//i.test(url) || /^https?:\/\//i.test(url);

  async function loadSources(){
    const r = await fetch("/api/sources");
    SOURCES = await r.json();
    setContinent("global");
    renderContinentTabs();
    setStatus("Prêt");
  }

  function renderContinentTabs(){
    const root = $("#continentTabs");
    root.innerHTML = CONTINENTS.map(c => `
      <button type="button" data-continent="${escapeHtml(c.key)}" class="${c.key === activeContinent ? "active" : ""}">
        ${escapeHtml(c.label)}
      </button>
    `).join("");
    root.querySelectorAll("button").forEach(btn=>{
      btn.addEventListener("click", () => {
        const key = btn.getAttribute("data-continent");
        if(!key) return;
        setContinent(key);
      });
    });
  }

  function setContinent(continent){
    activeContinent = continent;
    const scopedSources = continent === "global"
      ? SOURCES
      : SOURCES.filter(s => s.continent === continent);
    selected = new Set(scopedSources.map(s => s.key));
    renderContinentTabs();
    renderSourceToggles();
  }

  function renderSourceToggles(){
    const root = $("#sourceToggles");
    const visibleSources = activeContinent === "global"
      ? SOURCES
      : SOURCES.filter(s => s.continent === activeContinent);
    root.innerHTML = visibleSources.map(s => `
      <label class="src">
        <input type="checkbox" data-key="${escapeHtml(s.key)}" ${selected.has(s.key) ? "checked":""}/>
        ${escapeHtml(s.name)}
      </label>
    `).join("");
    root.querySelectorAll("input[type=checkbox]").forEach(cb=>{
      cb.addEventListener("change", e=>{
        const k = e.target.getAttribute("data-key");
        if(e.target.checked) selected.add(k); else selected.delete(k);
      });
    });
  }

  function setStatus(text){ $("#status").textContent = text; }

  async function search(){
    const q = $("#q").value.trim();
    if(selected.size === 0){
      setStatus("Choisis au moins 1 source");
      return;
    }
    setStatus("Recherche…");
    $("#count").textContent = "";

    const keys = Array.from(selected).join(",");
    const r = await fetch(`/api/search?q=${encodeURIComponent(q)}&sources=${encodeURIComponent(keys)}`);
    const data = await r.json();

    if(data.error){
      setStatus("Erreur");
      const details = data.warnings?.length
        ? ` (${data.warnings.length} source(s) en échec)`
        : "";
      $("#articles").innerHTML = `<div class="small">${escapeHtml(data.error)}${escapeHtml(details)} ${escapeHtml(data.details||"")}</div>`;
      return;
    }

    ITEMS = data.items || [];
    const warningText = data.warnings?.length
      ? ` — ${data.warnings.length} source(s) en échec`
      : "";
    setStatus(`Résultats pour: ${q || "tout"}${warningText}`);
    $("#count").textContent = `${ITEMS.length} item(s)`;
    renderArticles();
    summarizeSearch(q);
  }

  function renderArticles(){
    const root = $("#articles");
    root.innerHTML = ITEMS.map((it, idx) => `
      <article>
        <h3><span class="idx">#${idx + 1}</span><a href="${escapeHtml(it.link)}" target="_blank" rel="noopener noreferrer">${escapeHtml(it.title)}</a></h3>
        <div class="meta">
          <span>${escapeHtml(it.sourceName)}</span>
          <span>•</span>
          <span>${escapeHtml(it.pubDate ? new Date(it.pubDate).toLocaleString("fr-FR") : "")}</span>
        </div>
        <div class="snippet">${escapeHtml(it.snippet || "")}</div>
      </article>
    `).join("") || `<div class="small">Aucun résultat. Essaie un autre mot-clé (ex: “arctic”, “nato”, “ransomware”).</div>`;
  }

  function summarizeSearch(query){
    if(!ITEMS.length) return;
    const summary = summarizeByThemes(query || "Synthèse");
    chat.messages.push({
      role: "assistant",
      text: summary.text,
      cites: summary.cites
    });
    renderChat();
  }

  // Chatbot: répond UNIQUEMENT depuis ITEMS
  const chat = { messages: [
    { role:"assistant", text:"Je peux répondre de façon générale comme un chat classique. Pour des réponses sourcées, lance une recherche puis demande un résumé global ou un article (#)." }
  ]};

  function renderChat(){
    const log = $("#chatlog");
    log.innerHTML = chat.messages.map(m => `
      <div class="msg ${m.role==="user" ? "user":""}">
        <div class="who">${m.role==="user" ? "Toi":"Chatbot"}</div>
        <div class="txt">${escapeHtml(m.text)}</div>
        ${m.cites?.length ? `<div class="cites">Sources: ${
          m.cites.map(c => `${escapeHtml(c.sourceName)} — ${escapeHtml(c.title)}`).join(" | ")
        }</div>` : ""}
      </div>
    `).join("");
    log.scrollTop = log.scrollHeight;
  }

  function score(it, qTokens){
    const hay = tokenize([it.title, it.snippet, it.sourceName].join(" ")).join(" ");
    let s = 0;
    for(const t of qTokens){
      const re = new RegExp("\\\\b"+t+"\\\\b","g");
      s += (hay.match(re)||[]).length;
    }
    return s;
  }

  function topMatches(question, k=8){
    const qTokens = tokenize(question);
    if(qTokens.length===0) return [];
    return ITEMS
      .map(it => ({it, s: score(it, qTokens)}))
      .filter(x=>x.s>0)
      .sort((a,b)=>b.s-a.s)
      .slice(0,k);
  }

  function extractArticleIndex(question){
    const match = question.match(/#(\\d+)/);
    if (!match) return null;
    const idx = Number.parseInt(match[1], 10);
    if (Number.isNaN(idx) || idx < 1 || idx > ITEMS.length) return null;
    return idx - 1;
  }

  function summarizeByThemes(question){
    const qTokens = tokenize(question);
    const scopedItems = qTokens.length
      ? topMatches(question, 24).map(x => x.it)
      : ITEMS.slice(0, 24);
    const themes = [
      { label: "Politique", terms: ["gouvernement","président","ministre","élection","parlement","opposition","loi","réforme","parti"] },
      { label: "Économie", terms: ["économie","inflation","croissance","budget","marché","finance","investissement","banque","emploi","entreprise"] },
      { label: "Géopolitique", terms: ["diplomatie","traité","alliance","sanction","frontière","international","région","otan","onu","union"] },
      { label: "Sécurité", terms: ["sécurité","attaque","terrorisme","conflit","armée","militaire","crime","violence","insécurité","police"] }
    ];

    const buckets = themes.map(theme => ({
      label: theme.label,
      items: scopedItems.filter(it => {
        const hay = norm([it.title, it.snippet].join(" "));
        return theme.terms.some(term => hay.includes(norm(term)));
      })
    }));

    const fallbackItems = scopedItems.filter(it =>
      !buckets.some(bucket => bucket.items.includes(it))
    );

    const header = [
      `Bilan ${activeContinent === "global" ? "global" : `(${activeContinent})`}`,
      question.trim() ? `Sujet : ${question.trim()}` : "Sujet : (non précisé)"
    ];
    const lines = [header.join(" — "), ""];
    for(const bucket of buckets){
      if(bucket.items.length === 0) continue;
      lines.push(`${bucket.label} :`);
      for(const it of bucket.items.slice(0, 4)){
        lines.push(`- ${it.sourceName} : ${it.title}`);
      }
      lines.push("");
    }
    if(fallbackItems.length){
      lines.push("Autres points :");
      for(const it of fallbackItems.slice(0, 4)){
        lines.push(`- ${it.sourceName} : ${it.title}`);
      }
    }

    return {
      text: lines.join("\\n").trim(),
      cites: scopedItems.slice(0, 8)
    };
  }

  function genericAnswer(question){
    const qn = norm(question);
    const title = question.trim() ? `Sujet : ${question.trim()}` : "Sujet : (non précisé)";
    const isSummary = qn.includes("resume") || qn.includes("synthese");
    const isHow = qn.includes("comment");
    const isWhy = qn.startsWith("pourquoi");
    const isWhen = qn.startsWith("quand");
    const isWhat = qn.startsWith("quoi") || qn.startsWith("quest ce que") || qn.startsWith("qu est ce que");

    const lines = [];
    lines.push("Réponse générale (non sourcée) :");
    lines.push(`- ${title}`);
    if (isSummary) {
      lines.push("- Résumé : je peux faire une synthèse générale. Pour une synthèse sourcée d’articles, lance une recherche.");
    } else if (isHow) {
      lines.push("- Méthode : étapes clés, bonnes pratiques, points de vigilance.");
    } else if (isWhy) {
      lines.push("- Causes possibles : facteurs principaux, contexte, impacts.");
    } else if (isWhen) {
      lines.push("- Chronologie : repères temporels et conditions qui influencent le timing.");
    } else if (isWhat) {
      lines.push("- Définition : explication claire, exemples simples.");
    } else {
      lines.push("- Points clés : notions centrales, avantages/limites, exemples.");
    }
    lines.push("Si tu veux des sources vérifiables, lance une recherche et je m’appuierai sur les articles.");
    return lines.join("\\n");
  }

  function buildAnswer(question){
    if(ITEMS.length===0){
      return { text: genericAnswer(question), cites:[] };
    }
    const matches = topMatches(question, 10);
    if(matches.length===0){
      return { text:"Je ne trouve rien dans les résultats chargés qui corresponde. Reformule ou refais une recherche plus large.", cites:[] };
    }

    const qn = norm(question);
    const wantsSummary = qn.includes("resume") || qn.includes("synthese") || qn.includes("maj") || qn.includes("principales") || qn.includes("bilan");
    const wantsSources = qn.includes("source") || qn.includes("cite");
    const articleIndex = extractArticleIndex(question);
    const wantsArticleSummary = articleIndex !== null && (qn.includes("resume") || qn.includes("resumer"));
    const wantsGeneral = !wantsSummary && !wantsSources && !wantsArticleSummary;

    const lines = [];
    if(wantsArticleSummary){
      const it = ITEMS[articleIndex];
      lines.push(`Résumé de l’article #${articleIndex + 1} (${it.sourceName}) :`);
      lines.push(`- Titre : ${it.title}`);
      if (it.snippet) lines.push(`- Extrait : ${it.snippet}`);
      lines.push(`- Lien : ${it.link}`);
      return { text: lines.join("\\n"), cites: [it] };
    }
    if(wantsGeneral){
      return { text: genericAnswer(question), cites:[] };
    }
    if(wantsSummary){
      return summarizeByThemes(question);
    } else if(wantsSources){
      lines.push("Sources pertinentes dans les résultats :");
      for(const {it} of matches.slice(0,6)) lines.push(`- ${it.sourceName} : ${it.title}`);
    } else {
      lines.push("Éléments les plus proches de ta question :");
      for(const {it} of matches.slice(0,4)) lines.push(`- ${it.sourceName} : ${it.title}`);
      lines.push("");
      lines.push("Si tu veux, je peux faire une synthèse thématique (géopolitique / économie / cyber / défense).");
    }

    return { text: lines.join("\\n"), cites: matches.slice(0,6).map(x=>x.it) };
  }

  function send(){
    const q = $("#prompt").value.trim();
    if(!q) return;
    chat.messages.push({ role:"user", text:q });
    const ans = buildAnswer(q);
    chat.messages.push({ role:"assistant", text: ans.text, cites: ans.cites });
    $("#prompt").value = "";
    renderChat();
  }

  $("#searchBtn").addEventListener("click", search);
  $("#selectAll").addEventListener("click", () => {
    const scope = activeContinent === "global"
      ? SOURCES
      : SOURCES.filter(s => s.continent === activeContinent);
    selected = new Set(scope.map(s => s.key));
    renderSourceToggles();
  });
  $("#clearAll").addEventListener("click", () => {
    const scope = activeContinent === "global"
      ? SOURCES
      : SOURCES.filter(s => s.continent === activeContinent);
    const remaining = new Set(selected);
    scope.forEach(s => remaining.delete(s.key));
    selected = remaining;
    renderSourceToggles();
  });
  $("#toggleSources").addEventListener("change", e => {
    $("#sourceToggles").style.display = e.target.checked ? "flex" : "none";
  });
  function applyBackground(url){
    const safeUrl = (url || "").trim();
    if(!safeUrl){
      document.documentElement.style.setProperty("--map-image", DEFAULT_BG);
      localStorage.removeItem(BG_STORAGE_KEY);
      $("#bgUrl").value = "";
      return;
    }
    if(!isValidBg(safeUrl)){
      setStatus("URL de fond invalide");
      return;
    }
    const escaped = safeUrl.replace(/"/g, '\\"');
    document.documentElement.style.setProperty("--map-image", `url("${escaped}")`);
    localStorage.setItem(BG_STORAGE_KEY, safeUrl);
  }

  $("#applyBg").addEventListener("click", () => applyBackground($("#bgUrl").value));
  $("#resetBg").addEventListener("click", () => applyBackground(""));

  $("#q").addEventListener("keydown", e => {
    if(e.key === "Enter"){ e.preventDefault(); search(); }
  });
  $("#send").addEventListener("click", send);
  $("#reset").addEventListener("click", () => {
    chat.messages = [{ role:"assistant", text:"Chat réinitialisé. Fais une recherche puis pose ta question." }];
    renderChat();
  });

  renderChat();
  loadSources();

  const storedBg = localStorage.getItem(BG_STORAGE_KEY);
  if(storedBg && isValidBg(storedBg)){
    $("#bgUrl").value = storedBg;
    applyBackground(storedBg);
  } else if(storedBg) {
    localStorage.removeItem(BG_STORAGE_KEY);
  }
</script>
</body>
</html>
