<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Moteur d’actualité — recherche par mots-clés</title>
  <style>
    :root{--bg:#0b0f17;--card:#121a29;--text:#e7ecf5;--muted:#a9b4c7;--border:rgba(255,255,255,.10);--accent:#6aa6ff}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:linear-gradient(180deg,#070a12,#0b0f17);color:var(--text)}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(10px);background:rgba(11,15,23,.75);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:18px}
    .sub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.35}
    main{display:grid;grid-template-columns:1.6fr .9fr;gap:14px;padding:14px 16px 32px;max-width:1100px;margin:0 auto}
    @media(max-width:980px){main{grid-template-columns:1fr}}
    .panel{background:rgba(18,26,41,.75);border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .hd{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--border);flex-wrap:wrap}
    .bd{padding:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,textarea,button{background:#0c1220;color:var(--text);border:1px solid var(--border);padding:10px 11px;border-radius:12px;font:inherit}
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg,rgba(106,166,255,.25),rgba(106,166,255,.12));border-color:rgba(106,166,255,.35)}
    .badge{font-size:12px;color:var(--muted);border:1px solid var(--border);padding:6px 10px;border-radius:999px}
    .articles{display:grid;gap:10px}
    article{background:rgba(12,18,32,.6);border:1px solid var(--border);border-radius:14px;padding:12px}
    article h3{margin:0 0 6px 0;font-size:15px;line-height:1.25}
    .meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;color:var(--muted);font-size:12px}
    .snippet{margin-top:8px;color:#d7def0;line-height:1.45;font-size:14px}
    a{color:#cfe1ff}
    .chat{display:flex;flex-direction:column;height:72vh;min-height:520px}
    .chatlog{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
    .msg{max-width:92%;padding:10px;border-radius:14px;border:1px solid var(--border);background:rgba(12,18,32,.6)}
    .msg.user{align-self:flex-end;border-color:rgba(106,166,255,.35)}
    .who{font-size:12px;color:var(--muted);margin-bottom:6px}
    .txt{white-space:pre-wrap;line-height:1.4;font-size:14px}
    .cites{margin-top:8px;font-size:12px;color:var(--muted)}
    .small{font-size:12px;color:var(--muted);line-height:1.35}
    .sources{display:flex;flex-wrap:wrap;gap:10px}
    .src{display:flex;gap:8px;align-items:center;font-size:13px;color:var(--muted)}
    .source-actions{display:flex;gap:8px;flex-wrap:wrap}
    .ghost{background:transparent;border:1px dashed var(--border);color:var(--muted)}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Moteur d’actualité — recherche par mots-clés</h1>
    <div class="sub">Tape un mot-clé (ex: “Groenland”, “cybersécurité”, “OTAN”). Résultats issus de flux RSS ouverts. Le chatbot répond uniquement à partir des résultats chargés.</div>
  </div>
</header>

<main>
  <section class="panel">
    <div class="hd">
      <div class="row">
        <span class="badge" id="status">Prêt</span>
        <span class="small" id="count"></span>
      </div>
      <div class="row">
        <input id="q" type="search" placeholder='Ex: Groenland | cybersécurité | OTAN arctique' style="min-width:280px"/>
        <button class="primary" id="searchBtn">Rechercher</button>
      </div>
    </div>

    <div class="bd">
      <div class="row source-actions">
        <button class="ghost" id="selectAll">Tout sélectionner</button>
        <button class="ghost" id="clearAll">Tout désélectionner</button>
      </div>
      <div style="height:8px"></div>
      <div class="sources" id="sourceToggles"></div>
      <div style="height:10px"></div>
      <div class="articles" id="articles"></div>
    </div>
  </section>

  <aside class="panel chat">
    <div class="hd">
      <div class="row">
        <span class="badge">Chatbot</span>
        <span class="small">réponses sourcées</span>
      </div>
      <button class="primary" id="reset">Réinitialiser</button>
    </div>

    <div class="chatlog" id="chatlog"></div>

    <div class="bd" style="padding-top:0">
      <div class="row">
        <textarea id="prompt" placeholder="Ex : résume les infos majeures" style="flex:1; height:44px"></textarea>
        <button class="primary" id="send">Envoyer</button>
      </div>
      <div class="small" style="margin-top:10px">Astuce : demande “classe par thèmes”, “quels risques”, “cite tes sources”.</div>
    </div>
  </aside>
</main>

<script>
  const $ = s => document.querySelector(s);
  const escapeHtml = s => (s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const norm = s => (s||"").toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"").replace(/[^a-z0-9\\s-]/g," ").replace(/\\s+/g," ").trim();
  const tokenize = s => norm(s).split(" ").filter(t=>t.length>=2);

  let SOURCES = [];
  let selected = new Set();
  let ITEMS = [];

  async function loadSources(){
    const r = await fetch("/api/sources");
    SOURCES = await r.json();
    selected = new Set(SOURCES.filter(s=>s.enabledByDefault).map(s=>s.key));
    renderSourceToggles();
    setStatus("Prêt");
  }

  function renderSourceToggles(){
    const root = $("#sourceToggles");
    root.innerHTML = SOURCES.map(s => `
      <label class="src">
        <input type="checkbox" data-key="${escapeHtml(s.key)}" ${selected.has(s.key) ? "checked":""}/>
        ${escapeHtml(s.name)}
      </label>
    `).join("");
    root.querySelectorAll("input[type=checkbox]").forEach(cb=>{
      cb.addEventListener("change", e=>{
        const k = e.target.getAttribute("data-key");
        if(e.target.checked) selected.add(k); else selected.delete(k);
      });
    });
  }

  function setStatus(text){ $("#status").textContent = text; }

  async function search(){
    const q = $("#q").value.trim();
    if(selected.size === 0){
      setStatus("Choisis au moins 1 source");
      return;
    }
    setStatus("Recherche…");
    $("#count").textContent = "";

    const keys = Array.from(selected).join(",");
    const r = await fetch(`/api/search?q=${encodeURIComponent(q)}&sources=${encodeURIComponent(keys)}`);
    const data = await r.json();

    if(data.error){
      setStatus("Erreur");
      $("#articles").innerHTML = `<div class="small">${escapeHtml(data.error)} ${escapeHtml(data.details||"")}</div>`;
      return;
    }

    ITEMS = data.items || [];
    setStatus(`Résultats pour: ${q || "tout"}`);
    $("#count").textContent = `${ITEMS.length} item(s)`;
    renderArticles();
  }

  function renderArticles(){
    const root = $("#articles");
    root.innerHTML = ITEMS.map(it => `
      <article>
        <h3><a href="${escapeHtml(it.link)}" target="_blank" rel="noopener noreferrer">${escapeHtml(it.title)}</a></h3>
        <div class="meta">
          <span>${escapeHtml(it.sourceName)}</span>
          <span>•</span>
          <span>${escapeHtml(it.pubDate ? new Date(it.pubDate).toLocaleString("fr-FR") : "")}</span>
        </div>
        <div class="snippet">${escapeHtml(it.snippet || "")}</div>
      </article>
    `).join("") || `<div class="small">Aucun résultat. Essaie un autre mot-clé (ex: “arctic”, “nato”, “ransomware”).</div>`;
  }

  // Chatbot: répond UNIQUEMENT depuis ITEMS
  const chat = { messages: [
    { role:"assistant", text:"Je réponds uniquement à partir des résultats chargés (titres/extraits/liens) et je cite mes sources. Lance une recherche puis pose ta question." }
  ]};

  function renderChat(){
    const log = $("#chatlog");
    log.innerHTML = chat.messages.map(m => `
      <div class="msg ${m.role==="user" ? "user":""}">
        <div class="who">${m.role==="user" ? "Toi":"Chatbot"}</div>
        <div class="txt">${escapeHtml(m.text)}</div>
        ${m.cites?.length ? `<div class="cites">Sources: ${
          m.cites.map(c => `${escapeHtml(c.sourceName)} — ${escapeHtml(c.title)}`).join(" | ")
        }</div>` : ""}
      </div>
    `).join("");
    log.scrollTop = log.scrollHeight;
  }

  function score(it, qTokens){
    const hay = tokenize([it.title, it.snippet, it.sourceName].join(" ")).join(" ");
    let s = 0;
    for(const t of qTokens){
      const re = new RegExp("\\\\b"+t+"\\\\b","g");
      s += (hay.match(re)||[]).length;
    }
    return s;
  }

  function topMatches(question, k=8){
    const qTokens = tokenize(question);
    if(qTokens.length===0) return [];
    return ITEMS
      .map(it => ({it, s: score(it, qTokens)}))
      .filter(x=>x.s>0)
      .sort((a,b)=>b.s-a.s)
      .slice(0,k);
  }

  function buildAnswer(question){
    if(ITEMS.length===0){
      return { text:"Je n’ai aucun résultat chargé. Fais d’abord une recherche (ex: “Groenland”).", cites:[] };
    }
    const matches = topMatches(question, 10);
    if(matches.length===0){
      return { text:"Je ne trouve rien dans les résultats chargés qui corresponde. Reformule ou refais une recherche plus large.", cites:[] };
    }

    const qn = norm(question);
    const wantsSummary = qn.includes("resume") || qn.includes("synthese") || qn.includes("maj") || qn.includes("principales");
    const wantsSources = qn.includes("source") || qn.includes("cite");

    const lines = [];
    if(wantsSummary){
      lines.push("Synthèse basée sur les résultats chargés :");
      for(const {it} of matches.slice(0,5)) lines.push(`- ${it.sourceName} : ${it.title}`);
    } else if(wantsSources){
      lines.push("Sources pertinentes dans les résultats :");
      for(const {it} of matches.slice(0,6)) lines.push(`- ${it.sourceName} : ${it.title}`);
    } else {
      lines.push("Éléments les plus proches de ta question :");
      for(const {it} of matches.slice(0,4)) lines.push(`- ${it.sourceName} : ${it.title}`);
      lines.push("");
      lines.push("Si tu veux, je peux faire une synthèse thématique (géopolitique / économie / cyber / défense).");
    }

    return { text: lines.join("\\n"), cites: matches.slice(0,6).map(x=>x.it) };
  }

  function send(){
    const q = $("#prompt").value.trim();
    if(!q) return;
    chat.messages.push({ role:"user", text:q });
    const ans = buildAnswer(q);
    chat.messages.push({ role:"assistant", text: ans.text, cites: ans.cites });
    $("#prompt").value = "";
    renderChat();
  }

  $("#searchBtn").addEventListener("click", search);
  $("#selectAll").addEventListener("click", () => {
    selected = new Set(SOURCES.map(s => s.key));
    renderSourceToggles();
  });
  $("#clearAll").addEventListener("click", () => {
    selected = new Set();
    renderSourceToggles();
  });
  $("#q").addEventListener("keydown", e => {
    if(e.key === "Enter"){ e.preventDefault(); search(); }
  });
  $("#send").addEventListener("click", send);
  $("#reset").addEventListener("click", () => {
    chat.messages = [{ role:"assistant", text:"Chat réinitialisé. Fais une recherche puis pose ta question." }];
    renderChat();
  });

  renderChat();
  loadSources();
</script>
</body>
</html>
