<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AGORAFLUX</title>
  <style>
    :root{--bg:#0b0f17;--card:#121a29;--text:#e7ecf5;--muted:#a9b4c7;--border:rgba(255,255,255,.10);--accent:#6aa6ff;--glow:rgba(106,166,255,.25);--map-image:url("assets/world-map.png")}
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
      color:var(--text);
      background:
        radial-gradient(900px 480px at 10% -10%, rgba(106,166,255,.25), transparent 60%),
        radial-gradient(700px 420px at 90% 0%, rgba(106,166,255,.18), transparent 60%),
        linear-gradient(180deg,#070a12,#0b0f17);
      background-attachment: fixed;
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background-image:var(--map-image);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      opacity: 0.6;
      filter: contrast(1.15) saturate(1.15);
      pointer-events: none;
      z-index: -1;
    }
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(10px);background:rgba(11,15,23,.75);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:18px}
    .sub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.35}
    main{display:grid;grid-template-columns:.55fr 1.6fr .9fr;gap:14px;padding:14px 16px 32px;max-width:1200px;margin:0 auto}
    @media(max-width:1080px){main{grid-template-columns:1fr}}
    .panel{background:rgba(18,26,41,.45);border:1px solid rgba(255,255,255,.14);border-radius:16px;overflow:hidden;box-shadow:0 20px 40px rgba(0,0,0,.25);backdrop-filter:blur(6px)}
    .hd{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--border);flex-wrap:wrap}
    .bd{padding:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,textarea,button{background:#0c1220;color:var(--text);border:1px solid var(--border);padding:10px 11px;border-radius:12px;font:inherit}
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg,rgba(106,166,255,.25),rgba(106,166,255,.12));border-color:rgba(106,166,255,.35);box-shadow:0 10px 20px rgba(106,166,255,.15)}
    .badge{font-size:12px;color:var(--muted);border:1px solid var(--border);padding:6px 10px;border-radius:999px}
    .articles{display:grid;gap:10px}
    article{background:rgba(12,18,32,.38);border:1px solid rgba(255,255,255,.14);border-radius:14px;padding:12px}
    article h3{margin:0 0 6px 0;font-size:15px;line-height:1.25}
    .idx{display:inline-flex;align-items:center;justify-content:center;min-width:22px;height:22px;border-radius:999px;background:rgba(106,166,255,.15);border:1px solid rgba(106,166,255,.35);color:#cfe1ff;font-size:12px;margin-right:8px}
    .meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;color:var(--muted);font-size:12px}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border-radius:999px;font-size:11px;font-weight:600;letter-spacing:.2px;border:1px solid transparent}
    .tag-geo{background:rgba(103,194,255,.18);color:#cfe9ff;border-color:rgba(103,194,255,.35)}
    .tag-finance{background:rgba(255,107,107,.18);color:#ffd6d6;border-color:rgba(255,107,107,.35)}
    .tag-security{background:rgba(255,183,77,.2);color:#ffe0b2;border-color:rgba(255,183,77,.35)}
    .tag-health{background:rgba(76,217,138,.18);color:#d2f6e3;border-color:rgba(76,217,138,.35)}
    .tag-sport{background:rgba(120,190,255,.2);color:#d7ecff;border-color:rgba(120,190,255,.35)}
    .tag-politics{background:rgba(255,150,84,.2);color:#ffe2cc;border-color:rgba(255,150,84,.35)}
    .tag-general{background:rgba(163,177,198,.18);color:#e7ecf5;border-color:rgba(163,177,198,.35)}
    .snippet{margin-top:8px;color:#d7def0;line-height:1.45;font-size:14px}
    a{color:#cfe1ff}
    .chat{display:flex;flex-direction:column;height:72vh;min-height:520px}
    .chatlog{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
    .msg{max-width:92%;padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(12,18,32,.38)}
    .msg.user{align-self:flex-end;border-color:rgba(106,166,255,.35)}
    .who{font-size:12px;color:var(--muted);margin-bottom:6px}
    .txt{white-space:pre-wrap;line-height:1.4;font-size:14px}
    .cites{margin-top:8px;font-size:12px;color:var(--muted)}
    .small{font-size:12px;color:var(--muted);line-height:1.35}
    .sources{display:flex;flex-wrap:wrap;gap:10px}
    .src{display:flex;gap:8px;align-items:center;font-size:13px;color:var(--muted)}
    .toggle{display:flex;gap:8px;align-items:center;font-size:13px;color:var(--muted);background:rgba(12,18,32,.6);border:1px solid var(--border);padding:6px 10px;border-radius:999px}
    .source-actions{display:flex;gap:8px;flex-wrap:wrap}
    .ghost{background:transparent;border:1px dashed var(--border);color:var(--muted)}
    .idx{display:inline-flex;align-items:center;justify-content:center;min-width:22px;height:22px;border-radius:999px;background:rgba(106,166,255,.15);border:1px solid rgba(106,166,255,.35);color:#cfe1ff;font-size:12px;margin-right:8px}
    .bg-input{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .bg-input input{min-width:240px;flex:1}
    .bg-input .note{flex-basis:100%}
    .continents{position:sticky;top:90px;align-self:start}
    .tablist{display:flex;flex-direction:column;gap:8px}
    .tablist button{width:100%;text-align:left;border-radius:12px;background:rgba(12,18,32,.38);border:1px solid rgba(255,255,255,.14);padding:10px 12px}
    .tablist button.active{border-color:rgba(106,166,255,.55);background:rgba(106,166,255,.15);color:#cfe1ff}
    .tablist .small{margin-top:6px}
    .country-slider{display:flex;gap:10px;overflow:auto;padding-bottom:6px}
    .country-slider button{white-space:nowrap;border-radius:999px;background:rgba(12,18,32,.38);border:1px solid rgba(255,255,255,.14);padding:6px 10px;font-size:12px}
    .country-slider button.active{border-color:rgba(106,166,255,.55);background:rgba(106,166,255,.15);color:#cfe1ff}
    .ratings{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
    .rating-card{background:rgba(12,18,32,.38);border:1px solid rgba(255,255,255,.14);border-radius:14px;padding:10px}
    .rating-title{font-size:12px;color:var(--muted)}
    .rating-score{font-size:18px;font-weight:700}
    .rating-note{font-size:11px;color:var(--muted);margin-top:4px}
    .category-section{margin-top:14px}
    .category-section h4{margin:0 0 8px 0;font-size:14px}
    .advice{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.4}
    .ticker{max-width:1200px;margin:12px auto 0;padding:0 16px}
    .ticker .panel{display:flex;flex-direction:column;gap:10px}
    .ticker-track{display:flex;gap:24px;white-space:nowrap;overflow:hidden;position:relative}
    .ticker-items{display:inline-flex;gap:24px;animation:scroll 140s linear infinite}
    .ticker-item{display:inline-flex;gap:8px;align-items:center;font-size:13px;color:#d7def0}
    .ticker-item a{color:#cfe1ff;text-decoration:none}
    .ticker-item a:hover{text-decoration:underline}
    @keyframes scroll{
      0%{transform:translateX(0)}
      100%{transform:translateX(-50%)}
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1 id="siteName">AGORAFLUX</h1>
    <div class="sub">Tape un mot-clé (ex: “Groenland”, “cybersécurité”, “OTAN”). Résultats issus de flux RSS ouverts. Si aucune source n’est cochée, la recherche utilise toutes les sources.</div>
  </div>
</header>

<section class="ticker">
  <div class="panel">
    <div class="hd">
      <div class="row">
        <span class="badge">Actualités géopolitiques</span>
        <span class="small" id="geoStatus">Mise à jour…</span>
      </div>
    </div>
    <div class="bd">
      <div class="ticker-track">
        <div class="ticker-items" id="geoTicker"></div>
      </div>
    </div>
  </div>
</section>

<main>
  <aside class="panel continents">
    <div class="hd">
      <div class="row">
        <span class="badge">Continents</span>
        <span class="small">onglets</span>
      </div>
    </div>
    <div class="bd">
      <div class="tablist" id="continentTabs"></div>
      <div style="height:8px"></div>
      <div class="country-slider" id="countrySlider"></div>
      <div class="small" style="margin-top:10px">Chaque onglet recharge les sources liées à la zone sélectionnée.</div>
    </div>
  </aside>

  <section class="panel">
    <div class="hd">
      <div class="row">
        <span class="badge" id="status">Prêt</span>
        <span class="small" id="count"></span>
      </div>
      <div class="row">
        <input id="q" type="search" placeholder='Ex: Groenland | cybersécurité | OTAN arctique' style="min-width:280px"/>
        <button class="primary" id="searchBtn">Rechercher</button>
      </div>
    </div>

    <div class="bd">
      <div class="row source-actions">
        <button class="ghost" id="selectAll">Tout sélectionner</button>
        <button class="ghost" id="clearAll">Tout désélectionner</button>
        <label class="toggle">
          <input type="checkbox" id="toggleSources" checked />
          Afficher les sources
        </label>
      </div>
      <div style="height:10px"></div>
      <div class="row bg-input">
        <input id="bgUrl" type="url" placeholder="URL d’image de fond (ou data:image/...)" />
        <button class="ghost" id="applyBg">Appliquer</button>
        <button class="ghost" id="resetBg">Réinitialiser</button>
        <div class="small note">Astuce : utilise une URL publique ou un data URI base64 pour voir le fond s’afficher immédiatement.</div>
      </div>
      <div style="height:8px"></div>
      <div class="sources" id="sourceToggles"></div>
      <div style="height:10px"></div>
      <div id="countryDashboard"></div>
      <div class="articles" id="articles"></div>
    </div>
  </section>

  <aside class="panel chat">
    <div class="hd">
      <div class="row">
        <span class="badge">Chatbot</span>
        <span class="small">réponses sourcées</span>
      </div>
      <button class="primary" id="reset">Réinitialiser</button>
    </div>

    <div class="chatlog" id="chatlog"></div>

    <div class="bd" style="padding-top:0">
      <div class="row">
        <textarea id="prompt" placeholder="Ex : résume les infos majeures" style="flex:1; height:44px"></textarea>
        <button class="primary" id="send">Envoyer</button>
      </div>
      <div class="small" style="margin-top:10px">Astuce : demande “résume les articles”, “résume l’article #3”, “cite tes sources”.</div>
    </div>
  </aside>
</main>

<script>
  const $ = s => document.querySelector(s);
  const SITE_NAME = "AGORAFLUX";
  document.title = SITE_NAME;
  const siteNameEl = $("#siteName");
  if(siteNameEl) siteNameEl.textContent = SITE_NAME;
  const escapeHtml = s => (s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const norm = s => (s||"").toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"").replace(/[^a-z0-9\\s-]/g," ").replace(/\\s+/g," ").trim();
  const tokenize = s => norm(s).split(" ").filter(t=>t.length>=2);

  let SOURCES = [];
  let selected = new Set();
  let ITEMS = [];
  let geoSeen = new Set();
  let geoLastUpdate = null;
  let activeContinent = "global";
  let activeCountry = null;
  const CONTINENTS = [
    { key: "global", label: "Global" },
    { key: "Afrique", label: "Afrique" },
    { key: "Amérique du Nord", label: "Amérique du Nord" },
    { key: "Amérique du Sud", label: "Amérique du Sud" },
    { key: "Asie", label: "Asie" },
    { key: "Europe", label: "Europe" },
    { key: "Océanie", label: "Océanie" }
  ];
  const CONTINENT_COUNTRIES = {
    Afrique: ["Nigeria","South Africa","Kenya","Egypt","Morocco","Ghana","Senegal"],
    "Amérique du Nord": ["United States","Canada","Mexico"],
    "Amérique du Sud": ["Brazil","Argentina","Colombia","Chile","Peru"],
    Asie: ["China","India","Japan","South Korea","Indonesia","Pakistan"],
    Europe: ["France","Germany","United Kingdom","Italy","Spain","Ukraine","Russia"],
    Océanie: ["Australia","New Zealand"]
  };
  const COUNTRY_KEYWORDS = {
    Nigeria: ["nigeria","nigerian","abuja","lagos"],
    "South Africa": ["south africa","south african","johannesburg","pretoria","cape town"],
    Kenya: ["kenya","kenyan","nairobi"],
    Egypt: ["egypt","egyptian","cairo"],
    Morocco: ["morocco","moroccan","rabat","casablanca"],
    Ghana: ["ghana","ghanaian","accra"],
    Senegal: ["senegal","senegalese","dakar"],
    "United States": ["united states","usa","u.s.","washington","new york","america","american"],
    Canada: ["canada","canadian","ottawa","toronto"],
    Mexico: ["mexico","mexican","mexico city"],
    Brazil: ["brazil","brazilian","brasil","brasilia","rio","sao paulo","são paulo"],
    Argentina: ["argentina","argentine","buenos aires"],
    Colombia: ["colombia","colombian","bogota","bogotá"],
    Chile: ["chile","chilean","santiago"],
    Peru: ["peru","peruvian","lima"],
    China: ["china","chinese","beijing","peking"],
    India: ["india","indian","new delhi","delhi"],
    Japan: ["japan","japanese","tokyo"],
    "South Korea": ["south korea","korea","seoul"],
    Indonesia: ["indonesia","indonesian","jakarta"],
    Pakistan: ["pakistan","pakistani","islamabad"],
    France: ["france","french","paris"],
    Germany: ["germany","german","berlin","deutschland"],
    "United Kingdom": ["united kingdom","uk","britain","british","london"],
    Italy: ["italy","italian","rome","roma"],
    Spain: ["spain","spanish","madrid"],
    Ukraine: ["ukraine","ukrainian","kyiv","kiev"],
    Russia: ["russia","russian","moscow","moskva"],
    Australia: ["australia","australian","canberra","sydney","melbourne"],
    "New Zealand": ["new zealand","kiwi","wellington","auckland"]
  };
  const RISK_MAP_2026 = {
    Nigeria: { securityLevel: 4, medicalLevel: 4 },
    "South Africa": { securityLevel: 3, medicalLevel: 3 },
    Kenya: { securityLevel: 3, medicalLevel: 3 },
    Egypt: { securityLevel: 3, medicalLevel: 3 },
    Morocco: { securityLevel: 2, medicalLevel: 2 },
    Ghana: { securityLevel: 2, medicalLevel: 2 },
    Senegal: { securityLevel: 2, medicalLevel: 2 },
    "United States": { securityLevel: 2, medicalLevel: 2 },
    Canada: { securityLevel: 1, medicalLevel: 1 },
    Mexico: { securityLevel: 4, medicalLevel: 3 },
    Brazil: { securityLevel: 4, medicalLevel: 3 },
    Argentina: { securityLevel: 2, medicalLevel: 2 },
    Colombia: { securityLevel: 4, medicalLevel: 3 },
    Chile: { securityLevel: 2, medicalLevel: 2 },
    Peru: { securityLevel: 3, medicalLevel: 3 },
    China: { securityLevel: 3, medicalLevel: 2 },
    India: { securityLevel: 3, medicalLevel: 3 },
    Japan: { securityLevel: 1, medicalLevel: 1 },
    "South Korea": { securityLevel: 1, medicalLevel: 1 },
    Indonesia: { securityLevel: 3, medicalLevel: 3 },
    Pakistan: { securityLevel: 4, medicalLevel: 4 },
    France: { securityLevel: 2, medicalLevel: 1 },
    Germany: { securityLevel: 1, medicalLevel: 1 },
    "United Kingdom": { securityLevel: 2, medicalLevel: 1 },
    Italy: { securityLevel: 2, medicalLevel: 2 },
    Spain: { securityLevel: 2, medicalLevel: 2 },
    Ukraine: { securityLevel: 5, medicalLevel: 4 },
    Russia: { securityLevel: 4, medicalLevel: 3 },
    Australia: { securityLevel: 1, medicalLevel: 1 },
    "New Zealand": { securityLevel: 1, medicalLevel: 1 }
  };
  const DEFAULT_BG = getComputedStyle(document.documentElement).getPropertyValue("--map-image").trim();
  const BG_STORAGE_KEY = "customMapImageV2";
  const isValidBg = url => /^data:image\//i.test(url) || /^https?:\/\//i.test(url);

  async function loadSources(){
    const r = await fetch("/api/sources");
    SOURCES = await r.json();
    setContinent("global");
    renderContinentTabs();
    setStatus("Prêt");
  }

  function renderContinentTabs(){
    const root = $("#continentTabs");
    root.innerHTML = CONTINENTS.map(c => `
      <button type="button" data-continent="${escapeHtml(c.key)}" class="${c.key === activeContinent ? "active" : ""}">
        ${escapeHtml(c.label)}
      </button>
    `).join("");
    root.querySelectorAll("button").forEach(btn=>{
      btn.addEventListener("click", () => {
        const key = btn.getAttribute("data-continent");
        if(!key) return;
        setContinent(key);
      });
    });
  }

  function setContinent(continent){
    activeContinent = continent;
    const scopedSources = continent === "global"
      ? SOURCES
      : SOURCES.filter(s => s.continent === continent);
    selected = new Set(scopedSources.map(s => s.key));
    SidebarCountryTabs();
    renderSourceToggles();
    ContinentPage();
  }

  function renderCountrySlider(){
    const slider = $("#countrySlider");
    const countries = CONTINENT_COUNTRIES[activeContinent] || [];
    if (countries.length === 0){
      slider.innerHTML = "";
      activeCountry = null;
      return;
    }
    if (!activeCountry || !countries.includes(activeCountry)){
      activeCountry = countries[0];
    }
    slider.innerHTML = countries.map(country => `
      <button type="button" data-country="${escapeHtml(country)}" class="${country === activeCountry ? "active" : ""}">
        ${escapeHtml(country)}
      </button>
    `).join("");
    slider.querySelectorAll("button").forEach(btn => {
      btn.addEventListener("click", () => {
        const country = btn.getAttribute("data-country");
        if(!country) return;
        activeCountry = country;
        renderCountrySlider();
        CountryPage();
      });
    });
  }

  function SidebarCountryTabs(){
    renderContinentTabs();
  }

  function ContinentPage(){
    renderCountrySlider();
  }

  function CountrySlider(){
    renderCountrySlider();
  }

  function renderSourceToggles(){
    const root = $("#sourceToggles");
    const visibleSources = activeContinent === "global"
      ? SOURCES
      : SOURCES.filter(s => s.continent === activeContinent);
    root.innerHTML = visibleSources.map(s => `
      <label class="src">
        <input type="checkbox" data-key="${escapeHtml(s.key)}" ${selected.has(s.key) ? "checked":""}/>
        ${escapeHtml(s.name)}
      </label>
    `).join("");
    root.querySelectorAll("input[type=checkbox]").forEach(cb=>{
      cb.addEventListener("change", e=>{
        const k = e.target.getAttribute("data-key");
        if(e.target.checked) selected.add(k); else selected.delete(k);
      });
    });
  }

  function setStatus(text){ $("#status").textContent = text; }

  async function search(){
    const q = $("#q").value.trim();
    if(selected.size === 0){
      setStatus("Choisis au moins 1 source");
      return;
    }
    setStatus("Recherche…");
    $("#count").textContent = "";

    const keys = Array.from(selected).join(",");
    const r = await fetch(`/api/search?q=${encodeURIComponent(q)}&sources=${encodeURIComponent(keys)}`);
    const data = await r.json();

    if(data.error){
      setStatus("Erreur");
      const details = data.warnings?.length
        ? ` (${data.warnings.length} source(s) en échec)`
        : "";
      $("#articles").innerHTML = `<div class="small">${escapeHtml(data.error)}${escapeHtml(details)} ${escapeHtml(data.details||"")}</div>`;
      return;
    }

    ITEMS = data.items || [];
    const warningText = data.warnings?.length
      ? ` — ${data.warnings.length} source(s) en échec`
      : "";
    setStatus(`Résultats pour: ${q || "tout"}${warningText}`);
    $("#count").textContent = `${ITEMS.length} item(s)`;
    renderArticles();
    renderCountryPage();
    summarizeSearch(q);
  }

  async function loadGeopolitics(){
    const statusEl = $("#geoStatus");
    try{
      statusEl.textContent = "Mise à jour…";
      const q = "geopolitique geopolitics defense diplomacy conflict";
      const r = await fetch(`/api/search?q=${encodeURIComponent(q)}&sources=all`);
      const data = await r.json();
      geoLastUpdate = Date.now();
      const items = (data.items || []).slice(0, 24);
      const ticker = $("#geoTicker");
      if(items.length === 0){
        ticker.innerHTML = `<span class="small">Aucune actualité disponible pour le moment.</span>`;
        statusEl.textContent = "Aucune donnée";
        return;
      }
      if(geoSeen.size === 0){
        const entries = items.map(it => `
          <span class="ticker-item">
            <span class="idx">#</span>
            <a href="${escapeHtml(it.link)}" target="_blank" rel="noopener noreferrer">${escapeHtml(it.title)}</a>
            <span class="small">${escapeHtml(it.sourceName)}</span>
          </span>
        `).join("");
        ticker.innerHTML = entries + entries;
        items.forEach(it => {
          const key = it.link || `${it.sourceName}-${it.title}`;
          geoSeen.add(key);
        });
        statusEl.textContent = `Mis à jour • ${new Date().toLocaleTimeString("fr-FR")}`;
        return;
      }
      const now = Date.now();
      const cutoff = geoLastUpdate ? geoLastUpdate - 1000 : null;
      const fresh = items.filter(it => {
        const pub = it.pubDate ? new Date(it.pubDate).getTime() : null;
        if (cutoff === null) return true;
        if (!pub || Number.isNaN(pub)) return false;
        return pub >= cutoff;
      });
      const nextItems = fresh.length ? fresh : items;
      const unseen = nextItems.filter(it => {
        const key = it.link || `${it.sourceName}-${it.title}`;
        if (geoSeen.has(key)) return false;
        geoSeen.add(key);
        return true;
      });
      if(geoLastUpdate && unseen.length === 0){
        statusEl.textContent = `À jour • ${new Date().toLocaleTimeString("fr-FR")}`;
        geoLastUpdate = now;
        return;
      }
      const entries = unseen.length ? unseen : items;
      const html = entries.map(it => `
        <span class="ticker-item">
          <span class="idx">#</span>
          <a href="${escapeHtml(it.link)}" target="_blank" rel="noopener noreferrer">${escapeHtml(it.title)}</a>
          <span class="small">${escapeHtml(it.sourceName)}</span>
        </span>
      `).join("");
      ticker.innerHTML = html + html;
      statusEl.textContent = `Mis à jour • ${new Date().toLocaleTimeString("fr-FR")}`;
      geoLastUpdate = now;
    } catch (e) {
      statusEl.textContent = "Échec de mise à jour";
    }
  }

  function renderArticles(){
    const root = $("#articles");
    const list = activeCountry ? ITEMS.filter(matchCountry) : ITEMS;
    root.innerHTML = list.map((it, idx) => renderArticleCard(it, idx))
      .join("") || `<div class="small">Aucun résultat. Essaie un autre mot-clé (ex: “arctic”, “nato”, “ransomware”).</div>`;
  }

  function classifyCountryCategory(item){
    const text = norm([item.title, item.snippet, item.content, item.sourceName].join(" "));
    const weighted = (terms, weight, mustHave = []) => {
      const score = terms.reduce((acc, term) => acc + (text.includes(norm(term)) ? weight : 0), 0);
      if (mustHave.length && !mustHave.some(term => text.includes(norm(term)))) return 0;
      return score;
    };
    const categories = [
      {
        key: "geopolitique",
        label: "Géopolitique",
        className: "tag-geo",
        score:
          weighted(["geopolitique","geopolitics","relations internationales","diplomatie","diplomatic","sanction","embargo"], 3) +
          weighted(["conflit","conflict","guerre","war","occupation","invasion","frontiere","border"], 2, ["etat","state","pays","country","armement","armed"]) +
          weighted(["otan","nato","onu","un","alliance","treaty","traité","coalition"], 2)
      },
      {
        key: "finance",
        label: "Finance",
        className: "tag-finance",
        score:
          weighted(["marches","markets","bourse","stocks","indices","bond","obligation","taux","interest rate"], 3) +
          weighted(["banque","bank","central bank","fed","ecb","inflation","croissance","growth","recession"], 2) +
          weighted(["entreprise","company","corporate","earnings","results","profit","revenue","fusion","acquisition"], 2, ["entreprise","company","corporate"])
      },
      {
        key: "securitaire",
        label: "Sécuritaire",
        className: "tag-security",
        score:
          weighted(["securite","security","terrorisme","terror","attaque","attack","police","crime","violence"], 2) +
          weighted(["militaire","military","defense","defence","armes","weapons"], 2, ["securite","security","militaire","military"]) +
          weighted(["renseignement","intelligence","cyberattaque","cyberattack"], 2)
      },
      {
        key: "sanitaire",
        label: "Sanitaire",
        className: "tag-health",
        score:
          weighted(["sante","health","medecine","medicine","hopital","hospital","epidemie","epidemic","pandemie","pandemic"], 3) +
          weighted(["vaccin","vaccine","traitement","treatment","maladie","disease","sante publique","public health"], 2, ["sante","health","medecine","medicine"])
      },
      {
        key: "sport",
        label: "Sport",
        className: "tag-sport",
        score:
          weighted(["sport","football","soccer","basket","tennis","rugby","olympique","olympics","championnat","league"], 3) +
          weighted(["coupe","cup","fifa","uefa","nba","f1","formula 1"], 2, ["sport","football","soccer","basket","tennis"])
      },
      {
        key: "politique",
        label: "Politique intérieure",
        className: "tag-politics",
        score:
          weighted(["politique interieure","politique intérieure","government","gouvernement","president","président","parlement","election","élection","opposition","ministere","ministère","loi","reforme","réforme"], 3) +
          weighted(["parti","parties","vote","cabinet","majorite","majorité"], 2)
      }
    ];

    const ranked = categories
      .map(cat => ({ ...cat, score: cat.score || 0 }))
      .sort((a, b) => b.score - a.score);

    const primary = ranked[0]?.score > 0 ? ranked[0] : { key: "general", label: "Général", className: "tag-general", score: 0 };
    const secondary = ranked[1] && ranked[1].score >= 3 && ranked[1].score >= primary.score * 0.6
      ? ranked[1]
      : null;

    return { primary, secondary };
  }

  function renderArticleCard(item, idx){
    return `
      <article>
        <h3><span class="idx">#${idx + 1}</span><a href="${escapeHtml(item.link)}" target="_blank" rel="noopener noreferrer">${escapeHtml(item.title)}</a></h3>
        <div class="meta">
          <span>${escapeHtml(item.sourceName)}</span>
          <span>•</span>
          <span>${escapeHtml(item.pubDate ? new Date(item.pubDate).toLocaleString("fr-FR") : "")}</span>
          ${renderTag(item)}
        </div>
        <div class="snippet">${escapeHtml(item.snippet || "")}</div>
      </article>
    `;
  }

  function renderTag(item){
    const { primary, secondary } = classifyCountryCategory(item);
    const primaryHtml = `<span class="tag ${primary.className}">${escapeHtml(primary.label)}</span>`;
    const secondaryHtml = secondary
      ? `<span class="tag ${secondary.className}">${escapeHtml(secondary.label)}</span>`
      : "";
    return primaryHtml + secondaryHtml;
  }

  function matchCountry(item){
    if (!activeCountry) return true;
    const text = norm([item.title, item.snippet, item.content, item.sourceName].join(" "));
    const keywords = COUNTRY_KEYWORDS[activeCountry] || [activeCountry];
    return keywords.some(keyword => text.includes(norm(keyword)));
  }

  function renderCountryPage(){
    const dashboard = $("#countryDashboard");
    if (!activeCountry){
      dashboard.innerHTML = "";
      return;
    }
    const countryItems = ITEMS.filter(matchCountry);
    const categories = [
      { key: "securitaire", label: "Sécuritaire" },
      { key: "sanitaire", label: "Sanitaire" },
      { key: "operabilite", label: "Opérabilité business" },
      { key: "expat", label: "Faisabilité expatriés" },
      { key: "global", label: "Risque global" }
    ];
    const ratings = CategoryRatingsBar(countryItems, categories);
    const cards = ratings.map(r => `
      <div class="rating-card">
        <div class="rating-title">${escapeHtml(r.label)}</div>
        <div class="rating-score">${r.stars}/5</div>
        ${r.note ? `<div class="rating-note">${escapeHtml(r.note)}</div>` : ""}
      </div>
    `).join("");
    const sections = CategorySections(countryItems, [
      { key: "sport", label: "Sport" },
      { key: "geopolitique", label: "Géopolitique" },
      { key: "finance", label: "Finance" },
      { key: "sanitaire", label: "Sanitaire" },
      { key: "securitaire", label: "Sécuritaire" },
      { key: "politique", label: "Politique intérieure" }
    ]);
    const advice = buildEnterpriseAdvice(ratings);
    dashboard.innerHTML = `
      <div class="ratings">${cards}</div>
      <div class="advice">${escapeHtml(advice)}</div>
      ${sections}
    `;
  }

  function CategoryRatingsBar(countryItems, categories){
    return computeCategoryRatings(countryItems, categories, activeCountry);
  }

  function CategorySections(countryItems, categories){
    return categories.map(category => {
      const filtered = countryItems.filter(it => classifyCountryCategory(it).primary.key === category.key);
      if (filtered.length === 0) return "";
      return `
        <div class="category-section">
          <h4>${escapeHtml(category.label)}</h4>
          <div class="articles">
            ${filtered.map((it, idx) => renderArticleCard(it, idx)).join("")}
          </div>
        </div>
      `;
    }).join("");
  }

  function CountryPage(){
    renderCountryPage();
  }

  function computeCategoryRatings(items, categories, country){
    const now = Date.now();
    const windowDays = 30;
    const decay = 14;
    const byCategory = categories.map(cat => ({ ...cat, score: 0 }));
    const weightItem = (it, categoryKey) => {
      const ageDays = it.pubDate ? (now - new Date(it.pubDate).getTime()) / 86400000 : windowDays + 1;
      if (ageDays < 0 || ageDays > windowDays) return 0;
      const recency = Math.exp(-ageDays / decay);
      const text = norm([it.title, it.snippet, it.content].join(" "));
      const hits = text.split(" ").filter(Boolean).length;
      const importance = Math.min(5, 1 + Math.log10(hits + 1));
      const { primary, secondary } = classifyCountryCategory(it);
      const multiplier = primary.key === categoryKey ? 1 : secondary?.key === categoryKey ? 0.5 : 0;
      return recency * importance * multiplier;
    };
    const risk = getRiskRatings(country);
    const business = computeBusinessOperability(items, risk);
    const expat = computeExpatFeasibility(items, risk);
    const overall = computeOverallRisk({
      security: risk?.securityLevel ?? 3,
      medical: risk?.medicalLevel ?? 3,
      business,
      expat
    });
    byCategory.forEach(cat => {
      if(cat.key === "securitaire" && risk){
        cat.score = risk.securityLevel * 20;
        cat.stars = risk.securityLevel;
        cat.note = risk.securityLevel >= 4 ? "Contraintes fortes pour les équipes" : "Exposition gérable avec mesures adaptées";
        return;
      }
      if(cat.key === "sanitaire" && risk){
        cat.score = risk.medicalLevel * 20;
        cat.stars = risk.medicalLevel;
        cat.note = risk.medicalLevel >= 4 ? "Accès soins limité, prévoir évacuation" : "Soins disponibles avec vigilance";
        return;
      }
      if(cat.key === "operabilite"){
        cat.score = business * 20;
        cat.stars = business;
        cat.note = business >= 4 ? "Restrictions fréquentes" : "Opérations possibles avec procédures";
        return;
      }
      if(cat.key === "expat"){
        cat.score = expat * 20;
        cat.stars = expat;
        cat.note = expat >= 4 ? "Expatriation difficile" : "Expatriation possible avec support";
        return;
      }
      if(cat.key === "global"){
        cat.score = overall * 20;
        cat.stars = overall;
        cat.note = overall >= 4 ? "Approche critique requise" : "Approche standard renforcée";
        return;
      }
      cat.score = items.reduce((acc, it) => acc + weightItem(it, cat.key), 0);
    });
    const maxScore = Math.max(1, ...byCategory.map(cat => cat.score));
    return byCategory.map(cat => {
      if(cat.stars){
        return { ...cat, normalized: cat.score, stars: cat.stars, note: cat.note };
      }
      const normalized = Math.min(100, Math.round((cat.score / maxScore) * 100));
      const stars = Math.min(5, Math.max(1, Math.ceil(normalized / 20)));
      return { ...cat, normalized, stars };
    });
  }

  function getRiskRatings(country){
    if(!country) return null;
    const entry = RISK_MAP_2026[country];
    if(!entry) return null;
    return {
      securityLevel: Math.min(5, Math.max(1, entry.securityLevel)),
      medicalLevel: Math.min(5, Math.max(1, entry.medicalLevel))
    };
  }

  function computeBusinessOperability(items, risk){
    const riskBase = risk ? Math.round((risk.securityLevel + risk.medicalLevel) / 2) : 3;
    const disruptionSignals = ["strike","grève","curfew","couvre-feu","shutdown","blockade","route","transport","airport","rail"];
    const signalCount = items.filter(it => {
      const text = norm([it.title, it.snippet, it.content].join(" "));
      return disruptionSignals.some(term => text.includes(norm(term)));
    }).length;
    const signalBoost = Math.min(2, Math.floor(signalCount / 3));
    return clampRating(riskBase + signalBoost);
  }

  function computeExpatFeasibility(items, risk){
    const riskBase = risk ? Math.round((risk.securityLevel * 0.6) + (risk.medicalLevel * 0.4)) : 3;
    const evacuationSignals = ["evacuation","evacuate","medical evacuation","assistance","emergency"];
    const signalCount = items.filter(it => {
      const text = norm([it.title, it.snippet, it.content].join(" "));
      return evacuationSignals.some(term => text.includes(norm(term)));
    }).length;
    const signalBoost = Math.min(2, Math.floor(signalCount / 4));
    return clampRating(Math.round(riskBase) + signalBoost);
  }

  function computeOverallRisk({ security, medical, business, expat }){
    const score = (security * 0.35) + (medical * 0.25) + (business * 0.25) + (expat * 0.15);
    return clampRating(Math.round(score));
  }

  function clampRating(value){
    return Math.min(5, Math.max(1, value));
  }

  function buildEnterpriseAdvice(ratings){
    const overall = ratings.find(r => r.key === "global");
    const level = overall?.stars || 3;
    if(level >= 5){
      return "Mesures critiques : opérations très limitées, privilégier missions courtes, plans d’évacuation indispensables.";
    }
    if(level === 4){
      return "Mesures renforcées : suivi sûreté, prestataires dédiés, plan de crise et options d’évacuation.";
    }
    if(level === 3){
      return "Mesures structurées : procédures sûreté/santé, prestataires fiables, zones à éviter.";
    }
    return "Mesures standard : opérations possibles avec vigilance et briefings adaptés.";
  }

  function summarizeSearch(query){
    if(!ITEMS.length) return;
    const summary = summarizeByThemes(query || "Synthèse");
    chat.messages.push({
      role: "assistant",
      text: summary.text,
      cites: summary.cites
    });
    renderChat();
  }

  // Chatbot: répond UNIQUEMENT depuis ITEMS
  const chat = { messages: [
    { role:"assistant", text:"Je peux répondre de façon générale comme un chat classique. Pour des réponses sourcées, lance une recherche puis demande un résumé global ou un article (#)." }
  ]};

  function renderChat(){
    const log = $("#chatlog");
    log.innerHTML = chat.messages.map(m => `
      <div class="msg ${m.role==="user" ? "user":""}">
        <div class="who">${m.role==="user" ? "Toi":"Chatbot"}</div>
        <div class="txt">${escapeHtml(m.text)}</div>
        ${m.cites?.length ? `<div class="cites">Sources: ${
          m.cites.map(c => `${escapeHtml(c.sourceName)} — ${escapeHtml(c.title)}`).join(" | ")
        }</div>` : ""}
      </div>
    `).join("");
    log.scrollTop = log.scrollHeight;
  }

  function score(it, qTokens){
    const hay = tokenize([it.title, it.snippet, it.sourceName].join(" ")).join(" ");
    let s = 0;
    for(const t of qTokens){
      const re = new RegExp("\\\\b"+t+"\\\\b","g");
      s += (hay.match(re)||[]).length;
    }
    return s;
  }

  function topMatches(question, k=8){
    const qTokens = tokenize(question);
    if(qTokens.length===0) return [];
    return ITEMS
      .map(it => ({it, s: score(it, qTokens)}))
      .filter(x=>x.s>0)
      .sort((a,b)=>b.s-a.s)
      .slice(0,k);
  }

  function extractArticleIndex(question){
    const match = question.match(/#(\\d+)/);
    if (!match) return null;
    const idx = Number.parseInt(match[1], 10);
    if (Number.isNaN(idx) || idx < 1 || idx > ITEMS.length) return null;
    return idx - 1;
  }

  function summarizeByThemes(question){
    const qTokens = tokenize(question);
    const scopedItems = qTokens.length
      ? topMatches(question, 24).map(x => x.it)
      : ITEMS.slice(0, 24);
    const themes = [
      { label: "Politique", terms: ["gouvernement","président","ministre","élection","parlement","opposition","loi","réforme","parti"] },
      { label: "Économie", terms: ["économie","inflation","croissance","budget","marché","finance","investissement","banque","emploi","entreprise"] },
      { label: "Géopolitique", terms: ["diplomatie","traité","alliance","sanction","frontière","international","région","otan","onu","union"] },
      { label: "Sécurité", terms: ["sécurité","attaque","terrorisme","conflit","armée","militaire","crime","violence","insécurité","police"] }
    ];

    const buckets = themes.map(theme => ({
      label: theme.label,
      items: scopedItems.filter(it => {
        const hay = norm([it.title, it.snippet].join(" "));
        return theme.terms.some(term => hay.includes(norm(term)));
      })
    }));

    const fallbackItems = scopedItems.filter(it =>
      !buckets.some(bucket => bucket.items.includes(it))
    );

    const header = [
      `Bilan ${activeContinent === "global" ? "global" : `(${activeContinent})`}`,
      question.trim() ? `Sujet : ${question.trim()}` : "Sujet : (non précisé)"
    ];
    const lines = [header.join(" — "), ""];
    for(const bucket of buckets){
      if(bucket.items.length === 0) continue;
      lines.push(`${bucket.label} :`);
      for(const it of bucket.items.slice(0, 4)){
        lines.push(`- ${it.sourceName} : ${it.title}`);
      }
      lines.push("");
    }
    if(fallbackItems.length){
      lines.push("Autres points :");
      for(const it of fallbackItems.slice(0, 4)){
        lines.push(`- ${it.sourceName} : ${it.title}`);
      }
    }

    return {
      text: lines.join("\\n").trim(),
      cites: scopedItems.slice(0, 8)
    };
  }

  function genericAnswer(question){
    const qn = norm(question);
    const title = question.trim() ? `Sujet : ${question.trim()}` : "Sujet : (non précisé)";
    const isSummary = qn.includes("resume") || qn.includes("synthese");
    const isHow = qn.includes("comment");
    const isWhy = qn.startsWith("pourquoi");
    const isWhen = qn.startsWith("quand");
    const isWhat = qn.startsWith("quoi") || qn.startsWith("quest ce que") || qn.startsWith("qu est ce que");

    const lines = [];
    lines.push("Réponse générale (non sourcée) :");
    lines.push(`- ${title}`);
    if (isSummary) {
      lines.push("- Résumé : je peux faire une synthèse générale. Pour une synthèse sourcée d’articles, lance une recherche.");
    } else if (isHow) {
      lines.push("- Méthode : étapes clés, bonnes pratiques, points de vigilance.");
    } else if (isWhy) {
      lines.push("- Causes possibles : facteurs principaux, contexte, impacts.");
    } else if (isWhen) {
      lines.push("- Chronologie : repères temporels et conditions qui influencent le timing.");
    } else if (isWhat) {
      lines.push("- Définition : explication claire, exemples simples.");
    } else {
      lines.push("- Points clés : notions centrales, avantages/limites, exemples.");
    }
    lines.push("Si tu veux des sources vérifiables, lance une recherche et je m’appuierai sur les articles.");
    return lines.join("\\n");
  }

  function buildAnswer(question){
    if(ITEMS.length===0){
      return { text: genericAnswer(question), cites:[] };
    }
    const matches = topMatches(question, 10);
    if(matches.length===0){
      return { text:"Je ne trouve rien dans les résultats chargés qui corresponde. Reformule ou refais une recherche plus large.", cites:[] };
    }

    const qn = norm(question);
    const wantsSummary = qn.includes("resume") || qn.includes("synthese") || qn.includes("maj") || qn.includes("principales") || qn.includes("bilan");
    const wantsSources = qn.includes("source") || qn.includes("cite");
    const articleIndex = extractArticleIndex(question);
    const wantsArticleSummary = articleIndex !== null && (qn.includes("resume") || qn.includes("resumer"));
    const wantsGeneral = !wantsSummary && !wantsSources && !wantsArticleSummary;

    const lines = [];
    if(wantsArticleSummary){
      const it = ITEMS[articleIndex];
      lines.push(`Résumé de l’article #${articleIndex + 1} (${it.sourceName}) :`);
      lines.push(`- Titre : ${it.title}`);
      if (it.snippet) lines.push(`- Extrait : ${it.snippet}`);
      lines.push(`- Lien : ${it.link}`);
      return { text: lines.join("\\n"), cites: [it] };
    }
    if(wantsGeneral){
      return { text: genericAnswer(question), cites:[] };
    }
    if(wantsSummary){
      return summarizeByThemes(question);
    } else if(wantsSources){
      lines.push("Sources pertinentes dans les résultats :");
      for(const {it} of matches.slice(0,6)) lines.push(`- ${it.sourceName} : ${it.title}`);
    } else {
      lines.push("Éléments les plus proches de ta question :");
      for(const {it} of matches.slice(0,4)) lines.push(`- ${it.sourceName} : ${it.title}`);
      lines.push("");
      lines.push("Si tu veux, je peux faire une synthèse thématique (géopolitique / économie / cyber / défense).");
    }

    return { text: lines.join("\\n"), cites: matches.slice(0,6).map(x=>x.it) };
  }

  function send(){
    const q = $("#prompt").value.trim();
    if(!q) return;
    chat.messages.push({ role:"user", text:q });
    const ans = buildAnswer(q);
    chat.messages.push({ role:"assistant", text: ans.text, cites: ans.cites });
    $("#prompt").value = "";
    renderChat();
  }

  $("#searchBtn").addEventListener("click", search);
  $("#selectAll").addEventListener("click", () => {
    const scope = activeContinent === "global"
      ? SOURCES
      : SOURCES.filter(s => s.continent === activeContinent);
    selected = new Set(scope.map(s => s.key));
    renderSourceToggles();
  });
  $("#clearAll").addEventListener("click", () => {
    const scope = activeContinent === "global"
      ? SOURCES
      : SOURCES.filter(s => s.continent === activeContinent);
    const remaining = new Set(selected);
    scope.forEach(s => remaining.delete(s.key));
    selected = remaining;
    renderSourceToggles();
  });
  $("#toggleSources").addEventListener("change", e => {
    $("#sourceToggles").style.display = e.target.checked ? "flex" : "none";
  });
  function applyBackground(url){
    const safeUrl = (url || "").trim();
    if(!safeUrl){
      document.documentElement.style.setProperty("--map-image", DEFAULT_BG);
      localStorage.removeItem(BG_STORAGE_KEY);
      $("#bgUrl").value = "";
      return;
    }
    if(!isValidBg(safeUrl)){
      setStatus("URL de fond invalide");
      return;
    }
    const escaped = safeUrl.replace(/"/g, '\\"');
    document.documentElement.style.setProperty("--map-image", `url("${escaped}")`);
    localStorage.setItem(BG_STORAGE_KEY, safeUrl);
  }

  $("#applyBg").addEventListener("click", () => applyBackground($("#bgUrl").value));
  $("#resetBg").addEventListener("click", () => applyBackground(""));

  $("#q").addEventListener("keydown", e => {
    if(e.key === "Enter"){ e.preventDefault(); search(); }
  });
  $("#send").addEventListener("click", send);
  $("#reset").addEventListener("click", () => {
    chat.messages = [{ role:"assistant", text:"Chat réinitialisé. Fais une recherche puis pose ta question." }];
    renderChat();
  });

  renderChat();
  loadSources();
  loadGeopolitics();
  setInterval(loadGeopolitics, 300000);

  const storedBg = localStorage.getItem(BG_STORAGE_KEY);
  if(storedBg && isValidBg(storedBg)){
    $("#bgUrl").value = storedBg;
    applyBackground(storedBg);
  } else if(storedBg) {
    localStorage.removeItem(BG_STORAGE_KEY);
  }
</script>
</body>
</html>
